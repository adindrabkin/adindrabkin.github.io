document.addEventListener("DOMContentLoaded",()=>{const g="../js/airports.json",n=new Map;let r=[],e=-1;const m=document.getElementById("travel-form"),s=document.getElementById("departure-airport"),o=document.getElementById("arrival-airport"),i=document.getElementById("departure-results"),a=document.getElementById("arrival-results"),t=document.getElementById("error-message"),d=document.getElementById("awake-at-landing"),u=document.getElementById("awake-at-eod"),p=async()=>{try{const e=await fetch(g);if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);const t=await e.json();t.sort((e,t)=>e.s!==t.s?e.s-t.s:e.a.localeCompare(t.a)),r=t,t.forEach(e=>{e.i&&n.set(e.i,e)})}catch(e){console.error("Failed to load airport data:",e),t.textContent="Could not load airport data."}},l=t=>{const n=t.querySelectorAll("div");if(n.length===0)return;n.forEach(e=>e.classList.remove("autocomplete-active")),e>-1&&(n[e].classList.add("autocomplete-active"),n[e].scrollIntoView({block:"nearest"}))},f=(e,t,n)=>{if(n.innerHTML="",e.length===0)return;e.slice(0,10).forEach(e=>{const s=document.createElement("div");s.textContent=`${e.i} - ${e.a}`,s.addEventListener("click",()=>{t.value=e.i,n.innerHTML=""}),n.appendChild(s)})},h=(t,n)=>{e=-1;const o=t.target,s=o.value.toLowerCase().trim();if(s.length<1){n.innerHTML="";return}let i=r.filter(e=>{const t=e.a.toLowerCase(),n=e.i.toLowerCase(),o=e.tz.toLowerCase();return t.includes(s)||n.includes(s)||o.includes(s)});i.sort((e,t)=>{const a=e.i.toLowerCase(),r=t.i.toLowerCase(),c=e.a.toLowerCase(),l=t.a.toLowerCase(),d=e.tz.toLowerCase(),u=t.tz.toLowerCase(),n=(e,t,n)=>e===s?1:e.startsWith(s)?2:t.startsWith(s)?3:n.startsWith(s)?4:t.includes(s)?5:n.includes(s)?6:7,o=n(a,c,d),i=n(r,l,u);return o!==i?o-i:e.s!==t.s?e.s-t.s:e.a.localeCompare(t.a)}),f(i,o,n)},c=(t,n)=>{const s=n.querySelectorAll("div");if(s.length===0&&t.key!=="Enter")return;switch(t.key){case"ArrowDown":t.preventDefault(),e=(e+1)%s.length,l(n);break;case"ArrowUp":t.preventDefault(),e=(e-1+s.length)%s.length,l(n);break;case"Enter":e>-1&&(t.preventDefault(),s[e].click());break;case"Tab":e>-1&&(t.preventDefault(),s[e].click());break;case"Escape":t.preventDefault(),n.innerHTML="",e=-1;break}},v=e=>{e.preventDefault(),t.textContent="",d.textContent="--",u.textContent="--";const C=s.value.toUpperCase(),D=o.value.toUpperCase(),M=document.getElementById("wakeup-time").value,A=document.getElementById("arrival-time").value,l=document.getElementById("travel-day").value;if(!l){t.textContent="Please select a valid date.";return}const[v,g,f]=l.split("-").map(Number),a=n.get(C),m=n.get(D);if(!a||!m){t.textContent="Invalid IATA code. Please select an airport from the list.";return}const h=new Date(Date.UTC(v,g-1,f,12)),b=a.tz.replaceAll(" ","_"),j=m.tz.replaceAll(" ","_"),y=new Date(h.toLocaleString("en-US",{timeZone:b})),_=new Date(h.toLocaleString("en-US",{timeZone:j})),w=y.getTime()-_.getTime(),[O,x]=M.split(":").map(Number),p=O+x/60,[E,k]=A.split(":").map(Number),c=E+k/60,S=c+w/(1e3*60*60);let i=S-p;i<0&&(i+=24);const F=21,T=F-c,z=i+T,r=e=>{const t=Math.floor(e),n=Math.round((e-t)*60);return`${t} hours, ${n} minutes`};d.textContent=r(i),u.textContent=r(z)},b=()=>{document.getElementById("travel-day").valueAsDate=new Date,p(),s.addEventListener("input",e=>h(e,i)),o.addEventListener("input",e=>h(e,a)),s.addEventListener("keydown",e=>c(e,i)),o.addEventListener("keydown",e=>c(e,a)),document.addEventListener("click",e=>{e.target.closest(".autocomplete-container")||(i.innerHTML="",a.innerHTML="")}),m.addEventListener("submit",v)};b()})